<!DOCTYPE html>
<html lang="ru" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title></title>
    <link href="css/index.css" rel="stylesheet" type="text/css" media="screen" > <!--css страницы-->
    <link rel="stylesheet" href="css/leaflet.css" crossorigin="anonymous"/> <!--css для карты-->
    <link rel="stylesheet" href="css/mobile_side_menu.css"> <!--Мобильное меню левое-->
    <link href="css/vsplivaushee_okno.css" rel="stylesheet" type="text/css" media="screen" > <!--Всплывающее окно с контентом-->
    <link href="css/snow.min.css" rel="stylesheet"> <!--Снег-->

    <script src="js/leaflet.js" crossorigin="anonymous"></script> <!--js для карты-->
    <script src="js/respond.min.js"></script>
    <script type="module" src="js/model-viewer.min.js"></script>
    <script src="js/Snow.js"></script> <!--Снег-->
    <script src="js/lamboteSnow.js"></script>

    <style>
    /*css всплывающего окна маркера. Регулирует задний фон и затемнение. Нужно этот код переместить тута, где ему место.*/
      /* Добавьте в ваш CSS файл */
      .custom-popup .leaflet-popup-content-wrapper {
          transition: background-image 0.3s ease;
          min-height: 150px; /* Минимальная высота */

          display: flex;
          justify-content: center;  /* Центрируем по горизонтали */
          align-items: center;      /* Центр по вертикали */
      }

      .custom-popup .leaflet-popup-content {
          background-color: rgba(0, 0, 0, 0.5); /* Полупрозрачный фон для контента */
          padding: 5% 5%; /* 10% слева и справа (итого 20% padding, 80% контента) Таким образом можем регулировать размеры всплывающего окна*/
          border-radius: 5px;
      }

      .custom-popup .leaflet-popup-tip {
          background: rgba(0, 0, 0, 0.8);
      }
    </style>
  </head>
  <body>

    <!--Скрытый checkbox, отвечающий за переключение панели, должен быть в
    верхней части документа, лучше сразу после тега `<body>`, `id` атрибут
    предназначен для связки с атрибутом `for` тега <label> - кнопки вызова меню.
    Атрибут `hidden` указывает состояние «скрытый» у текущего элемента-->
    <input type="checkbox" id="nav-toggle" hidden>

    <!--Верхнее мобильное меню-->
    <div class="top_menu_mobail">
      <div class="top_menu_div_with_mobail_logo">
        <img src="files/logo.png">
      </div>
      <div class="top_menu_div_with_mobail_text">
        <p align="center" >ГОРОД ЯРОСЛАВЛЬ</p>
      </div>
    </div>

    <!--Левое меню [mobail]-->
    <nav class="nav">
        <!--
        Метка с именем `id` чекбокса в `for` атрибуте
        Символ Unicode 'TRIGRAM FOR HEAVEN' (U+2630)
        Пустой атрибут `onclick` используем для исправления бага в iOS < 6.0
        См: http://timpietrusky.com/advanced-checkbox-hack
        -->
        <label for="nav-toggle" class="nav-toggle" onclick></label>

        <div class="nav_content">
          <p align="center">ВАШ ПУТЕВОДИТЕЛЬ</p>
          <iframe src="str/putevoditel.html"></iframe>
        </div>
    </nav>

    <!--Левое меню [pc]-->
    <div id="left_menu" class="left_menu">
      <!--Блок с логотипом-->
      <div class="div_with_logo">
        <a href="#" id="notify-button">
          <img src="files/logo.png" alt="">
        </a>
      </div>

      <!--Блок с путеводителем-->
      <div class="div_with_travel_guide">
        <!--Блок с наполнением-->
        <div class="travel_guide_text">
          <p align="center">ПУТЕВОДИТЕЛЬ</p>
          <iframe id="myFrame" class="frame_bok_menu" src="str/putevoditel.html" style="width: 19vw; height: 53vh; border: none;"></iframe>
        </div>
      </div>

      <!--Блок с информацией по сайту-->
      <div class="div_with_info">
        <!--Блок с наполнением-->
        <div class="info_text">
          <p align="center"><a href="#" onclick="showImages('Engravings'); document.getElementById('myHeading').textContent = 'ГРАВЮРЫ'; return false;">ГРАВЮРЫ</a></p>
          <hr>
          <a href="#" onclick="window.open('https://rutube.ru/video/98f25d07ad66eb5a2add61fa56209ed5/?ysclid=m5xtflus7o87399491', '_blank');">ВИДЕО О КАРТЕ</a>
        </div>
      </div>
    </div>

    <!--Блок с картой-->
    <div class="map" id='map'>
      <div class="upper_curb_on_the_map">
        <div class="block_with_content_text_on_the_map">
          <div class="the_content_text_on_the_map">
            <p align="center">ГОРОД ЯРОСЛАВЛЬ</p>
            <hr>
            <p align="center" class="text2">ВТОРОЙ ПОЛОВИНЫ XVIII ВЕКА</p>
          </div>
        </div>
      </div>
    </div>

    <!--Модальное окно с 3D моделями--> <!--ПРОДОЛЖАЕМ РАЗРАБОТКУ С МОДАЛЬНОГО ОКНА. ПОКА ОНО ПРОСТО ПОДКЛЮЧЕНО ПО СТИЛЯМ CSS (В <head>) И РАЗМЕТКЕ-->

    <div class="dm-overlay" id="win1" style="overflow-y: hidden; margin: 0 auto;">
        <div class="dm-table" id="dm-table">
          <div class="dm-cell">
            <div class="dm-modal" style="width: 100%; height:100%;">
              <br><a href="#close" class="close"></a>
              <h3 id="myHeading">Онлайн реконструкция</h3>
              <div class="pl-left">
              </div>
              <div style="position: relative;">
                <model-viewer style="width: 100%; height: 70vh;" alt="" src="" ar shadow-intensity="1" camera-controls touch-action="pan-y" class='modelHram' id="modelHram"></model-viewer>
                <iframe frameBorder="0" src='' class='iframo-pedia' id='iframo-pedia' style='width: 98%; height: 100%; position: absolute; top: 1em; left: 50%; transform: translateX(-50%);'></iframe>
              </div>
            </div>
          </div>
        </div>
    </div>

    <script>
        // Конфигурация карты
        const MAP_BOUNDS = [[0, 0], [1000, 1000]];
        const MAP_CENTER = [500, 500];
        const MAP_ZOOM = -1;

        // Инициализация карты
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -1,
            maxZoom: 4
        });

        // Установка границ и изображения карты
        const bounds = MAP_BOUNDS.map(([x, y]) => L.latLng(y, x));
        L.imageOverlay('files/maps/old_Yaroslavl.webp', bounds).addTo(map);
        map.setMaxBounds(L.latLngBounds(bounds));
        map.setView(L.latLng(...MAP_CENTER), MAP_ZOOM);

        // Иконки маркеров
        const icons = {
            regular: (zoom) => L.icon({
                iconUrl: 'files/other/regular.png',
                iconSize: [10 * Math.pow(1.3, zoom - MAP_ZOOM), 10 * Math.pow(1.3, zoom - MAP_ZOOM)],
                iconAnchor: [5 * Math.pow(1.3, zoom - MAP_ZOOM), 5 * Math.pow(1.3, zoom - MAP_ZOOM)]
            }),
            regularBacklight: (zoom) => L.icon({
                iconUrl: 'files/other/regular_backlight.png',
                iconSize: [10 * Math.pow(1.3, zoom - MAP_ZOOM), 10 * Math.pow(1.3, zoom - MAP_ZOOM)],
                iconAnchor: [5 * Math.pow(1.3, zoom - MAP_ZOOM), 5 * Math.pow(1.3, zoom - MAP_ZOOM)]
            }),
            significant: (zoom) => L.icon({  // Теперь принимает zoom
                iconUrl: 'files/other/significant.png',
                iconSize: [10 * Math.pow(1.3, zoom - MAP_ZOOM), 10 * Math.pow(1.3, zoom - MAP_ZOOM)],
                iconAnchor: [5 * Math.pow(1.3, zoom - MAP_ZOOM), 5 * Math.pow(1.3, zoom - MAP_ZOOM)]
            }),
            significantBacklight: (zoom) => L.icon({  // Теперь принимает zoom
                iconUrl: 'files/other/significant_backlight.png',
                iconSize: [10 * Math.pow(1.3, zoom - MAP_ZOOM), 10 * Math.pow(1.3, zoom - MAP_ZOOM)],
                iconAnchor: [5 * Math.pow(1.3, zoom - MAP_ZOOM), 5 * Math.pow(1.3, zoom - MAP_ZOOM)]
            })
        };

        // Координаты маркеров
        const markerLocations = {
            number1: [95.5, 932.5],
            number2: [110.0, 872.0],
            number3: [105.0, 908.0],
            number4: [165.0, 940.0],
            number5: [130.0, 928.0],
            number6: [108.0, 942.0],
            number7: [128.0, 942.5],
            number8: [110.0, 950.5],
            number9: [79.0, 933.0],
            number10: [170.0, 888.0],
            number11: [229.0, 910.0],
            number12: [244.0, 883.0],
            number13: [360.0, 868.0],
            number14: [430.0, 860.0],
            number15: [423.0, 825.0],
            number16: [262.0, 738.0],
            number17: [348.5, 799.5],
            number18: [293.5, 838.5],
            number19: [222.5, 847.0],
            number20: [211.5, 850.0],
            number21: [209.0, 800.0],
            number22: [120.0, 831.0],
            number23: [120.0, 780.0],
            number24: [223.0, 838.0],
            number25: [113.0, 711.0],
            number26: [379.0, 725.0],
            number27: [137.0, 774.0],
            number28: [257.0, 914.0],
            number28A: [385.0, 882.0],
            number29: [148.0, 811.0],
            number30: [168.0, 798.0],
            number31: [116.0, 843.0],
            number32: [244.6, 834.0],
            number33: [162.0, 811.0],
            number34: [210.6, 816.0],
            number35: [169.0, 803.0],
            number36: [155.5, 793.5],
            number37: [216.88, 879.03],
            number38: [130.0, 813.5],
            number39: [405.4, 812.7],
            number39A: [244.10, 727.89],
            number40: [349.70, 768.76],
            number41: [194.33, 856.82],
            number42: [191.64, 888.88],
            number43: [142.52, 784.51],
            number44: [73.30, 840.02],
            number68: [130.0, 685.0],
            number70: [554.0, 735.5],
            number71: [597.0, 843.0],
            number72: [810.00, 824.03],//
            number83: [158.0, 593.0],
            number84: [430.5, 141.0],
            strelka: [45.0, 960.0]
        };

        // Данные маркеров с путями к 3D моделям
        const markersData = [
            {
                location: markerLocations.number1,
                icon: icons.significant,
                title: "Кафедральный Успенский собор",
                popupBackground: "Cathedral of the Assumption Cathedral",
                modelPath: "files/3D_files/Cathedral_of_the_Assumption_Cathedral.glb",
                modelAction360: "Cathedral of the Assumption Cathedral",
                infoAction: "showInfo('Cathedral of the Assumption Cathedral')",
                imagesAction: "showImages('Cathedral of the Assumption Cathedral')"
            },
            {
                location: markerLocations.number2,
                icon: icons.significant,
                title: "Церковь Николы Рубленого",
                popupBackground: "The Church of St. Nicholas the Chopped",
                modelPath: "files/3D_files/Church_of_St._Nicholas_the_Chopped.glb",
                infoAction: "showInfo('The Church of St. Nicholas the Chopped')",
                imagesAction: "showImages('The Church of St. Nicholas the Chopped')"
            },
            {
                location: markerLocations.number3,
                icon: icons.regular,
                title: "Толгская церковь",
                popupBackground: "Tolga Church",
                infoAction: "showInfo('Tolga Church')"
            },
            {
                location: markerLocations.number4,
                icon: icons.significant,
                title: "Ильинско-Тихоновская церковь",
                popupBackground: "Ilyinsko - Tikhonovskaya Church",
                modelPath: "files/3D_files/Ilyinsko-Tikhonovskaya_Church.glb",
                infoAction: "showInfo('Ilyinsko - Tikhonovskaya Church')",
                imagesAction: "showImages('Ilyinsko - Tikhonovskaya Church')"
            },
            {
                location: markerLocations.number5,
                icon: icons.significant,
                title: "Церковь Иоанна Златауста",
                popupBackground: "St. John Chrysostom Church",
                modelPath: "files/3D_files/St._John_Chrysostom_Church.glb",
                infoAction: "showInfo('St. John Chrysostom Church')",
                imagesAction: "showImages('St. John Chrysostom Church')"
            },
            {
                location: markerLocations.number6,
                icon: icons.regular,
                title: "Церковь Леонтия Чудотворца (при архиерейском доме)",
                popupBackground: "Church of St. Leontius the Wonderworker (at the Bishop`s house)",
                infoAction: "showInfo('Church of St. Leontius the Wonderworker (at the Bishop`s house)')",
                imagesAction: "showImages('Church of St. Leontius the Wonderworker (at the Bishop`s house)')"
            },
            {
                location: markerLocations.number7,
                icon: icons.significant,
                title: "Архиерейский дом (бывш. метрополичьи палаты)",
                popupBackground: "Bishop`s House (formerly metropolitan chambers)",
                modelPath: "files/3D_files/Bishop`s House_(formerly metropolitan chambers).glb",
                infoAction: "showInfo('Bishop`s House (formerly metropolitan chambers)')",
                imagesAction: "showImages('Bishop`s House (formerly metropolitan chambers)')"
            },
            {
                location: markerLocations.number8,
                icon: icons.regular,
                title: "Флигель и хоз. постройки при архиерейском доме",
                popupBackground: "Bishop`s House (formerly metropolitan chambers)"
            },
            {
                location: markerLocations.number9,
                icon: icons.regular,
                title: "Комендантский дом (бывш. воеводский)",
                infoAction: "showInfo('The Commandant`s House (formerly voivodsky)')",
            },
            {
                location: markerLocations.number10,
                icon: icons.regular,
                title: "Церковь Фрола и Лавра",
                infoAction: "showInfo('Church of Frol and Lavra')"
            },
            {
                location: markerLocations.number11,
                icon: icons.regular,
                title: "Церковь Бориса и Глеба",
                infoAction: "showInfo('Boris and Gleb Church')"
            },
            {
                location: markerLocations.number12,
                icon: icons.regular,
                title: "Церковь Козьмы и Демьяна",
                popupBackground: "Church of Kozma and Demyan",
                infoAction: "showInfo('Church of Kozma and Demyan')",
                imagesAction: "showImages('Church of Kozma and Demyan')"
            },
            {
                location: markerLocations.number13,
                icon: icons.significant,
                title: "Церковь Николы Надеина",
                popupBackground: "Church of St. Nicholas Nadein",
                modelPath: "files/3D_files/Church_of_St._Nicholas_Nadein.glb",
                infoAction: "showInfo('Church of St. Nicholas Nadein')",
                imagesAction: "showImages('Church of St. Nicholas Nadein')"
            },
            {
                location: markerLocations.number14,
                icon: icons.regular,
                title: "Церковь Рождества Христова",
                popupBackground: "Church of the Nativity",
                infoAction: "showInfo('Church of the Nativity')",
                imagesAction: "showImages('Church of the Nativity')"
            },
            {
                location: markerLocations.number15,
                icon: icons.regular,
                title: "Церковь Великомученницы Варвары",
                popupBackground: "The Church of the Great Martyr Barbara",
                infoAction: "showInfo('The Church of the Great Martyr Barbara')",
                imagesAction: "showImages('The Church of the Great Martyr Barbara')"
            },
            {
                location: markerLocations.number16,
                icon: icons.regular,
                title: "Церковь Сретения Господня",
                popupBackground: "The Church of the Presentation of the Lord",
                infoAction: "showInfo('The Church of the Presentation of the Lord')",
                imagesAction: "showImages('The Church of the Presentation of the Lord')"
            },
            {
                location: markerLocations.number17,
                icon: icons.regular,
                title: "Церковь Всех святых",
                popupBackground: "Church of All Saints",
                infoAction: "showInfo('Church of All Saints')",
                imagesAction: "showImages('Church of All Saints')"
            },
            {
                location: markerLocations.number18,
                icon: icons.regular,
                title: "Церковь Ильи Пророка",
                popupBackground: "Church of Elijah the Prophet",
                modelAction360: "Church of Elijah the Prophet",
                infoAction: "showInfo('Church of Elijah the Prophet')",
                imagesAction: "showImages('Church of Elijah the Prophet')"
            },
            {
                location: markerLocations.number19,
                icon: icons.regular,
                title: "Спасо-пробоинская церковь",
                popupBackground: "Spaso-Proboinskaya Church",
                infoAction: "showInfo('Spaso-Proboinskaya Church')",
                imagesAction: "showImages('Spaso-Proboinskaya Church')"
            },
            {
                location: markerLocations.number20,
                icon: icons.regular,
                title: "Церковь Воскресения Господня",
                popupBackground: "Church of the Resurrection of the Lord",
                infoAction: "showInfo('Church of the Resurrection of the Lord')",
                imagesAction: "showImages('Church of the Resurrection of the Lord')"
            },
            {
                location: markerLocations.number21,
                icon: icons.regular,
                title: "Церковь Леонтия Чудотворца",
                popupBackground: "Church of Leontius the Wonderworker",
                infoAction: "showInfo('Church of Leontius the Wonderworker')",
                imagesAction: "showImages('Church of Leontius the Wonderworker')"
            },
            {
                location: markerLocations.number22,
                icon: icons.regular,
                title: "Церковь Спаса на городу",
                popupBackground: "Church of the Savior on the City",
                infoAction: "showInfo('Church of the Savior on the City')",
                imagesAction: "showImages('Church of the Savior on the City')"
            },
            {
                location: markerLocations.number23,
                icon: icons.significant,
                title: "Церковь Архангела Михаила",
                popupBackground: "Church of the Archangel Michael",
                modelPath: "files/3D_files/Church_of_the_Archangel_Michael.glb",
                tourAction: "window.location.href = 'str/tours/ArkhangelMikhael/index.html';",
                videoAction: "window.open('https://vkvideo.ru/video-83055312_456239040', '_blank');",
                infoAction: "showInfo('Church of the Archangel Michael')",
                imagesAction: "showImages('Church of the Archangel Michael')"
            },
            {
                location: markerLocations.number24,
                icon: icons.regular,
                title: "Кирилло-Афанасьевский монастырь",
                popupBackground: "Kirillo-Afanasyevsky Monastery",
                infoAction: "showInfo('Kirillo-Afanasyevsky Monastery')",
                imagesAction: "showImages('Kirillo-Afanasyevsky Monastery')"
            },
            {
                location: markerLocations.number25,
                icon: icons.regular,
                title: "Спасо-преображенский монастырь",
                popupBackground: "Spaso-Preobrazhensky Monastery",
                infoAction: "showInfo('Spaso-Preobrazhensky Monastery')",
                imagesAction: "showImages('Spaso-Preobrazhensky Monastery')"
            },
            {
                location: markerLocations.number26,
                icon: icons.regular,
                title: "Казанский женский монастырь",
                popupBackground: "Kazan Women`s Monostyr",
                infoAction: "showInfo('Kazan Women`s Monostyr')",
                imagesAction: "showImages('Kazan Women`s Monostyr')"
            },
            {
                location: markerLocations.number27,
                icon: icons.regular,
                title: "Острог"
            },
            {
                location: markerLocations.number28,
                icon: icons.regular,
                title: "Дом коменданта г.Ярославля",
                infoAction: "showInfo('The house of the commandant of Yaroslavl')"
            },
            {
                location: markerLocations.number28A,
                icon: icons.regular,
                title: "Воеводский двор"
            },
            {
                location: markerLocations.number29,
                icon: icons.regular,
                title: "Воеводская канцелярия с училещем для дворянских детей"
            },
            {
                location: markerLocations.number30,
                icon: icons.regular,
                title: "Провинциальная канцелярия",
                infoAction: "showInfo('Provincial Office')"
            },
            {
                location: markerLocations.number31,
                icon: icons.regular,
                title: "Городовой магистрат",
                infoAction: "showInfo('City Magistrate')"
            },
            {
                location: markerLocations.number32,
                icon: icons.regular,
                title: "Дом общего гражданства"
            },
            {
                location: markerLocations.number33,
                icon: icons.regular,
                title: "Землемерная чертежная",
                infoAction: "showInfo('Land survey drawing office')"
            },
            {
                location: markerLocations.number34,
                icon: icons.regular,
                title: "Ярославская народная школа"
            },
            {
                location: markerLocations.number35,
                icon: icons.regular,
                title: "Дворянская гимназия",
                infoAction: "showInfo('Noble Gymnasium')"
            },
            {
                location: markerLocations.number36,
                icon: icons.regular,
                title: "Кухня дворянской гимназии",
            },
            {
                location: markerLocations.number37,
                icon: icons.regular,
                title: "Питейный дом и богадельня Питеева",
            },
            {
                location: markerLocations.number38,
                icon: icons.regular,
                title: "'Красная' богадельня с городовой школой (бывшю кладовой анбар и двор купца Барсова)",
            },
            {
                location: markerLocations.number39,
                icon: icons.regular,
                title: "Варваринская богадельня"
            },
            {
                location: markerLocations.number39A,
                icon: icons.regular,
                title: "Сретенская богадельня"
            },
            {
                location: markerLocations.number40,
                icon: icons.regular,
                title: "Аптекарский дом"
            },
            {
                location: markerLocations.number41,
                icon: icons.regular,
                title: "Купеческие лавки"
            },
            {
                location: markerLocations.number42,
                icon: icons.regular,
                title: "Кладовые анбары купца Барсова"
            },
            {
                location: markerLocations.number43,
                icon: icons.regular,
                title: "Кладовые анбары Демидова"
            },
            {
                location: markerLocations.number44,
                icon: icons.regular,
                title: "Анбар с землею Саввы Яковлева",
                infoAction: "showInfo('Anbar with the land of Savva Yakovlev')",
                imagesAction: "showImages('Anbar with the land of Savva Yakovlev')"
            },
            {
                location: markerLocations.number68,
                icon: icons.significant,
                title: "Церковь Богоявления Господня",
                popupBackground: "Church of the Epiphany of the Lord",
                modelPath: "files/3D_files/Church_of_the_Epiphany_of_the_Lord.glb",
                modelAction360: "Church of the Epiphany of the Lord",
                infoAction: "showInfo('Church of the Epiphany of the Lord')",
                imagesAction: "showImages('Church of the Epiphany of the Lord')"
            },
            {
                location: markerLocations.number70,
                icon: icons.significant,
                title: "Церковь Симеона Столпника",
                popupBackground: "Simeon Stylites Church",
                modelPath: "files/3D_files/Simeon_Stylites_Church.glb",
                infoAction: "showInfo('Simeon Stylites Church')",
                imagesAction: "showImages('Simeon Stylites Church')"
            },
            {
                location: markerLocations.number71,
                icon: icons.significant,
                title: "Благовещенская церковь",
                popupBackground: "Annunciation Church",
                modelPath: "files/3D_files/Annunciation_Church.glb",
                infoAction: "showInfo('Annunciation Church')",
                imagesAction: "showImages('Annunciation Church')"
            },
            {
                location: markerLocations.number72,
                icon: icons.regular,
                title: "Церковь Петра и Павла",
                popupBackground: "Church of Peter and Paul",
                infoAction: "showInfo('Church of Peter and Paul')",
                imagesAction: "showImages('Church of Peter and Paul')"
            },
            {
                location: markerLocations.number83,
                icon: icons.significant,
                title: "Церковь Дмитрия Солунского",
                popupBackground: "The Church of Dmitry Solunsky",
                modelPath: "files/3D_files/The_Church_of_Dmitry_Solunsky.glb",
                infoAction: "showInfo('The Church of Dmitry Solunsky')",
                imagesAction: "showImages('The Church of Dmitry Solunsky')"
            },
            {
                location: markerLocations.number84,
                icon: icons.significant,
                title: "Владимирская церковь (на Божедомке)",
                popupBackground: "St. Vladimir`s Church (on Bozhedomka)",
                modelPath: "files/3D_files/St._Vladimir`s_Church_(on Bozhedomka).glb",
                infoAction: "showInfo('St. Vladimir`s Church (on Bozhedomka)')",
                imagesAction: "showImages('St. Vladimir`s Church (on Bozhedomka)')"
            },
            {
                location: markerLocations.strelka,
                icon: icons.significant,
                title: "Ярославская Стрелка",
                popupBackground: "Yaroslavskaya strelka",
                modelAction360: "Yaroslavskaya strelka",
                infoAction: "showInfo('Yaroslavskaya strelka')",
                imagesAction: "showImages('Yaroslavskaya strelka')"
            }
        ];

        // Функция для отображения 3D модели
        function showModel(modelSrc, showIframopedia = false) {
            document.getElementById('modelHram').src = modelSrc;
            document.getElementById('win1').style.display = 'flex';
            document.getElementById('iframo-pedia').style.display = showIframopedia ? 'block' : 'none';
        }

        // Функция для отображения информации
        function showInfo(page) {
            showModel(null, true);
            document.querySelector('#iframo-pedia').src = `str/iframo-pedia/${page}/text.html?timestamp=${Date.now()}`;
        }

        // Функция для отображения картинок
        function showImages(page) {
            showModel(null, true);
            document.querySelector('#iframo-pedia').src = `str/iframo-pedia/${page}/images.html?timestamp=${Date.now()}`;
        }

        function createMarker({
            location,
            icon,
            title,
            modelPath,
            modelAction360,
            infoAction,
            tourAction,
            videoAction,
            imagesAction,
            popupBackground
        }) {
            const currentZoom = map.getZoom();
            const markerIcon = typeof icon === 'function' ? icon(currentZoom) : icon;

            // Генерация пути для 360° панорамы, если указано только название папки
            const panoramaPath = modelAction360
                ? `window.location.href = 'str/iframo-pedia/${modelAction360}/panorama.html';`
                : '';

            const popupContent = `
                <div class="popup-content-inner">
                    <h3>${title}</h3>
                    <div class="popup-buttons">
                        ${modelPath ? `<button onclick="showModel('${modelPath}')">3D</button>` : ''}
                        ${modelAction360 ? `<button onclick="${panoramaPath}">360°</button>` : ''}
                        ${tourAction ? `<button onclick="${tourAction}">Тур 360°</button>` : ''}
                        ${infoAction ? `<button onclick="${infoAction}">Информация</button>` : ''}
                        ${imagesAction ? `<button onclick="${imagesAction}">Картинки</button>` : ''}
                        ${videoAction ? `<button onclick="${videoAction}">Видео</button>` : ''}
                    </div>
                </div>`;

            const marker = L.marker(L.latLng(...location), {
                icon: markerIcon
            }).bindPopup(popupContent, {
                className: 'custom-popup',
                maxWidth: 300,
                minWidth: 200
            });

            // Функция для установки фона
            const setBackground = (wrapper, bgFolder) => {
                const defaultBg = 'files/other/DefaultMarkerBackground.jpg';
                const bgPath = bgFolder
                    ? `str/iframo-pedia/${bgFolder}/background.jpg`
                    : defaultBg;

                const img = new Image();
                img.onload = function() {
                    wrapper.style.backgroundImage = `url('${bgPath}')`;
                    wrapper.style.backgroundSize = 'cover';
                    wrapper.style.backgroundPosition = 'center';
                    wrapper.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    wrapper.style.color = '#fff';
                    wrapper.style.textShadow = '1px 1px 3px rgba(0,0,0,0.8)';
                };
                img.onerror = function() {
                    // Если не загрузилось ни кастомное, ни дефолтное изображение
                    if (bgFolder) {
                        // Пробуем загрузить дефолтное
                        setBackground(wrapper, null);
                    } else {
                        wrapper.style.backgroundImage = '';
                        wrapper.style.backgroundColor = '#fff';
                        wrapper.style.color = '#333';
                        wrapper.style.textShadow = 'none';
                    }
                };
                img.src = bgPath;
            };

            marker.on('popupopen', function() {
                const popup = this.getPopup();
                const contentWrapper = popup.getElement().querySelector('.leaflet-popup-content-wrapper');

                // Устанавливаем фон (кастомный или дефолтный)
                setBackground(contentWrapper, popupBackground);

                document.getElementById('myHeading').textContent = title;

                const newZoom = map.getZoom();
                if (icon === icons.regular) {
                    this.setIcon(icons.regularBacklight(newZoom));
                } else if (icon === icons.significant) {
                    this.setIcon(icons.significantBacklight(newZoom));
                }
            });

            marker.on('popupclose', function() {
                const newZoom = map.getZoom();
                if (typeof icon === 'function') {
                    this.setIcon(icon(newZoom));
                } else {
                    this.setIcon(icon);
                }
            });

            return marker;
        }

        // Создание и добавление маркеров на карту
        const markers = markersData.map(markerData => createMarker(markerData));
        markers.forEach(marker => marker.addTo(map));

        // Обработчик изменения масштаба
        map.on('zoomend', function() {
            const currentZoom = map.getZoom();

            markers.forEach(marker => {
                const markerData = markersData.find(data => {
                    const markerLatLng = marker.getLatLng();
                    return markerLatLng.lat === data.location[0] &&
                           markerLatLng.lng === data.location[1];
                });

                if (markerData && typeof markerData.icon === 'function') {
                    const isPopupOpen = marker.isPopupOpen();
                    let newIcon;

                    if (markerData.icon === icons.regular && isPopupOpen) {
                        newIcon = icons.regularBacklight(currentZoom);
                    } else if (markerData.icon === icons.significant && isPopupOpen) {
                        newIcon = icons.significantBacklight(currentZoom);
                    } else {
                        newIcon = markerData.icon(currentZoom);
                    }

                    marker.setIcon(newIcon);
                }
            });
        });

        function handleIframeLinkClick(event) {
            event.preventDefault();
            const clickedTitle = event.target.textContent.trim().replace(/^\d+\.\s*/, '');
            const correspondingMarkerData = markersData.find(marker => marker.title === clickedTitle);

            if (correspondingMarkerData) {
                const correspondingMarker = markers.find(marker => {
                    const markerLatLng = marker.getLatLng();
                    return markerLatLng.lat === correspondingMarkerData.location[0] &&
                           markerLatLng.lng === correspondingMarkerData.location[1];
                });

                if (correspondingMarker) {
                    const currentZoom = map.getZoom();
                    let newIcon;

                    // Исправленная логика установки иконки
                    if (correspondingMarkerData.icon === icons.regular) {
                        newIcon = icons.regularBacklight(currentZoom);
                    } else if (correspondingMarkerData.icon === icons.significant) {
                        newIcon = icons.significantBacklight(currentZoom); // Добавлен currentZoom
                    } else {
                        // Если icon не является функцией, используем его как есть
                        newIcon = correspondingMarkerData.icon;
                    }

                    correspondingMarker.setIcon(newIcon);
                    correspondingMarker.openPopup();
                    map.setView(correspondingMarker.getLatLng(), currentZoom);
                    resetMarkers(correspondingMarker);
                }
            }
        }

        // Функция для сброса иконок маркеров
        function resetMarkers(exceptMarker) {
            const currentZoom = map.getZoom();
            markers.forEach(marker => {
                if (marker !== exceptMarker) {
                    const markerData = markersData.find(data => {
                        const markerLatLng = marker.getLatLng();
                        return markerLatLng.lat === data.location[0] &&
                               markerLatLng.lng === data.location[1];
                    });
                    if (markerData && typeof markerData.icon === 'function') {
                        marker.setIcon(markerData.icon(currentZoom));
                    }
                }
            });
        }

        // Инициализация обработчика iframe
        document.getElementById('myFrame').onload = function() {
            const iframeDocument = this.contentDocument || this.contentWindow.document;
            const links = iframeDocument.getElementsByTagName('a');

            Array.from(links).forEach(link => {
                link.addEventListener('click', handleIframeLinkClick);
            });
        };

        // Обработчики событий
        document.getElementById('notify-button').addEventListener('click', () => {
            alert("Связь с разработчиком: ip-feedback@mail.ru \nТелефон музея: Тел: 8 (4852) 30-41-75");
        });

        document.getElementById('left_menu').addEventListener('click', () => {
            markers.forEach(marker => marker.closePopup());
        });

        document.querySelector('.close').addEventListener('click', () => {
            document.getElementById('win1').style.display = 'none';
        });

        // Проверка месяца для запуска снега
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();

        if ([11, 0, 1].includes(currentMonth)) {
            new Snow();
        }
    </script>

    <script>
        // Переменные для отслеживания состояния
        let isCtrlKeyPressed = false;
        let isBackquotePressed = false;
        let lastMouseCoords = null;

        // Обработчики клавиш
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) isCtrlKeyPressed = true;
            if (e.key === 'ё' || e.key === '`' || e.code === 'Backquote') isBackquotePressed = true;

            if (isCtrlKeyPressed && isBackquotePressed) {
                document.body.classList.add('coords-mode');
                updateCoordsPopup();
            }
        });

        document.addEventListener('keyup', function(e) {
            if (e.key === 'Control') isCtrlKeyPressed = false;
            if (e.key === 'ё' || e.key === '`' || e.code === 'Backquote') isBackquotePressed = false;

            if (!isCtrlKeyPressed || !isBackquotePressed) {
                document.body.classList.remove('coords-mode');
                if (map._coordsPopup) {
                    map.removeLayer(map._coordsPopup);
                    map._coordsPopup = null;
                }
            }
        });

        // Функция обновления координат
        function updateCoordsPopup() {
            if (isCtrlKeyPressed && isBackquotePressed && lastMouseCoords) {
                const x = lastMouseCoords.lng.toFixed(2);
                const y = lastMouseCoords.lat.toFixed(2);
                const coordsText = y + ', ' + x;

                navigator.clipboard.writeText(coordsText).catch(err => {
                    console.error('Ошибка копирования:', err);
                });

                if (!map._coordsPopup) {
                    map._coordsPopup = L.popup({
                        closeButton: false,
                        autoClose: false,
                        closeOnClick: false,
                        className: 'coords-popup'
                    })
                    .setLatLng(lastMouseCoords)
                    .setContent('X: ' + x + ', Y: ' + y + '<br>Скопировано: ' + coordsText)
                    .openOn(map);
                } else {
                    map._coordsPopup
                        .setLatLng(lastMouseCoords)
                        .setContent('X: ' + x + ', Y: ' + y + '<br>Скопировано: ' + coordsText);
                }
            }
        }

        // Отслеживание движения мыши
        map.on('mousemove', function(e) {
            lastMouseCoords = e.latlng;
            updateCoordsPopup();
        });

        // Стили с исправленной строкой content
        const style = document.createElement('style');
        style.textContent = `
            .coords-mode {
                cursor: crosshair !important;
            }
            .coords-mode::after {
                content: "Режим координат (Ctrl + \\00B4)";
                position: fixed;
                bottom: 10px;
                right: 10px;
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 5px 10px;
                border-radius: 5px;
                z-index: 1000;
                font-family: Arial, sans-serif;
                font-size: 14px;
            }
            .coords-popup .leaflet-popup-content-wrapper {
                background: rgba(0,0,0,0.7);
                color: white;
                border-radius: 4px;
                box-shadow: 0 0 10px rgba(0,0,0,0.5);
            }
            .coords-popup .leaflet-popup-content {
                margin: 5px 10px;
                font-size: 14px;
                font-family: monospace;
            }
            .coords-popup .leaflet-popup-tip {
                background: rgba(0,0,0,0.7);
            }
        `;
        document.head.appendChild(style);
    </script>

  </body>
</html>
